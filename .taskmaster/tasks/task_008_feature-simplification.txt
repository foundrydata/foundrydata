# Task ID: 8
# Title: Composition Engine
# Status: pending
# Dependencies: 2, 3, 4, 6, 7, 8000, 9000, 9107, 9108, 9111, 9113, 9114, 9115
# Priority: high
# Description: Build effective view, CoverageIndex (has/enumerate), branch selection, early-unsat hints, caps; AP:false must-cover and Strict/Lax behaviors.
# Details:
[Context] §8 coverage-index-export/enumerate; AP:false must-cover and fail-fast; branch-selection; oneOf exclusivity (Compose side); regex caps; §14 memo keys.
- spec://§8#coverage-index-export, spec://§8#coverage-index-enumerate, spec://§8#apfalse-must-cover, spec://§8#branch-selection, spec://§8#oneof-exclusivity, spec://§8#regex-complexity-cap
- spec://§14#planoptionssubkey
[Retrieval]
- REFONLY::{"source":"FILE","uri":"docs/feature-simplification/feature-support-simplification.md","section":"§8","anchors":["spec://§8#coverage-index-export","spec://§8#coverage-index-enumerate","spec://§8#apfalse-must-cover","spec://§8#branch-selection","spec://§8#oneof-exclusivity","spec://§8#regex-complexity-cap"],"notes":"no-embed; fetch-on-demand"}
[Key requirements]
- Export CoverageIndex for every object; enumerate only when provably finite by allowed sources; provenance sorted.
- Strict fail-fast AP_FALSE_UNSAFE_PATTERN only under presence pressure and only when Safe set is empty; Lax warns.
- Score-only invariants: always record tiebreakRand (even when |T|=1); budget.skipped=true; limit per Top-K calc.
- **DEPENDENCY**: Requires normalized schema output from Normalizer (task 7) to build effective view and CoverageIndex.
[Deliverables]
- packages/core/src/transform/composition-engine.ts
[Commands]
- pnpm i; pnpm -w build; pnpm -w test; pnpm -w bench
[Definition of Done]
- Deterministic branch selection; CoverageIndex.has/enumerate pure; diagnostics emitted with correct locus; caps limited to compose-time set.

# Test Strategy:
Unit: enumerate order and provenance; AP:false safe proof vs fail-fast routing; score-only path with tiebreakRand present; early-unsat hints payloads shapes; memo key includes PlanOptionsSubKey.

# Subtasks:
## 1. Effective view & CoverageIndex [pending]
### Dependencies: None
### Description: Implement core effective view computation and CoverageIndex data structure with has/enumerate methods
### Details:
Build the core effective view computation that processes normalized schemas from the Normalizer (task 7). Implement CoverageIndex class with has() and enumerate() methods, ensuring enumerate only operates on provably finite sources. Handle AP:false must-cover requirements with Safe/Unsafe pattern detection. Export CoverageIndex for every object schema processed.

## 2. Branch selector & diagnostics [pending]
### Dependencies: None
### Description: Implement deterministic branch selection with score-only invariants and diagnostic emission
### Details:
Implement branch selection algorithm with deterministic tiebreakRand recording (even for |T|=1 cases). Handle Strict vs Lax behaviors for AP_FALSE_UNSAFE_PATTERN routing. Implement early-unsat hints generation and diagnostic emission with correct locus information. Ensure memo keys include PlanOptionsSubKey for proper caching.

